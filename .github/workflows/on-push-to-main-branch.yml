name: On Push to Main Branch

on:
  push:
    branches: [ main ]

env:
  TEST_ECR_REPO: public.ecr.aws/c9o0b7e4
  PROD_ECR_REPO: public.ecr.aws/c9o0b7e4
  ECR_USER_AGENT: aws-privateca-issuer

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
    - name: Check out code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - name: Setup Dockerx
      uses: docker/setup-buildx-action@v1
    - name: Setup AWS Credentials
      uses: aws-actions/configure-aws-credentials@master
      with:
        role-to-assume: arn:aws:iam::905418208571:role/GithubActionsPublishRole-wrichman-us-east-1
        aws-region: us-east-1
    - name: Login to Public ECR
      uses: docker/login-action@v1
      with:
        registry: public.ecr.aws
      env:
        AWS_REGION: us-east-1
    - name: Setup Push to ECR
      run: |
        export PLUGIN_VERSION=$(git describe --tags)
        export TAG_BASE=${{ env.TEST_ECR_REPO }}/$(echo ${GITHUB_REPOSITORY,,} | sed s#/#-#)-test
        echo TAG_BASE=$TAG_BASE >> $GITHUB_ENV
        echo PLUGIN_VERSION=$PLUGIN_VERSION >> $GITHUB_ENV
    - name: Build and push container images
      uses: docker/build-push-action@v6
      with:
        build-args: |
          pkg_version=${{ env.PLUGIN_VERSION }}
        context: .
        platforms: linux/amd64,linux/arm64
        tags: |
          ${{ env.TAG_BASE }}:latest
          ${{ env.TAG_BASE }}:${{ env.PLUGIN_VERSION }}
        push: true

  version-bump:
    runs-on: ubuntu-latest
    outputs:
      bump_type: ${{ steps.pr_labels.outputs.bump_type }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR labels
        id: pr_labels
        uses: actions/github-script@v7
        with:
          script: |
            const commits = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha
            });

            core.info('Commit: ' + context.sha);
            core.info('Commits: ' + commits.data);
            core.setOutput('bump_type', 'none');
            if (commits.data.length > 0) {
              const labels = commits.data[0].labels.map(label => label.name);
              core.info('PR Labels:' + labels);

              const hasMinor = labels.includes('Minor Version');
              const hasPatch = labels.includes('Patch');

              if (hasMinor) {
                core.setOutput('bump_type', 'minor');
              } else if (hasPatch) {
                core.setOutput('bump_type', 'patch');
              }
            }
      - name: No version bump
        if: steps.pr_labels.outputs.bump_type == 'none'
        run: |
          echo "No version bump label found. Skipping version update."

  get-versions:
    runs-on: ubuntu-latest
    needs: version-bump
    if: ${{ needs.version-bump.outputs.bump_type != 'none' }}
    outputs:
      new_version: ${{ steps.bump_version.outputs.new_version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get current version
        id: get_version
        run: |
          # Get the latest tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null)
          echo "Current version: $LATEST_TAG"
          echo "current_version=$LATEST_TAG" >> $GITHUB_OUTPUT

      - name: Bump version
        id: bump_version
        run: |
          CURRENT="${{ steps.get_version.outputs.current_version }}"
          BUMP_TYPE="${{ needs.version-bump.outputs.bump_type }}"
          
          CURRENT=${CURRENT#v}
          
          IFS='.' read -r -a VERSION_PARTS <<< "$CURRENT"
          MAJOR="${VERSION_PARTS[0]}"
          MINOR="${VERSION_PARTS[1]}"
          PATCH="${VERSION_PARTS[2]}"
          
          if [ "$BUMP_TYPE" = "minor" ]; then
            MINOR=$((MINOR + 1))
            PATCH=0
          elif [ "$BUMP_TYPE" = "patch" ]; then
            PATCH=$((PATCH + 1))
          fi
          
          NEW_VERSION="v${MAJOR}.${MINOR}.${PATCH}"
          echo "New version: $NEW_VERSION"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "version_number=${MAJOR}.${MINOR}.${PATCH}" >> $GITHUB_OUTPUT

  version-validation-beta:
    needs: [get-versions, build]
    if: ${{ needs.get-versions.result == 'success' && needs.build.result == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v4
        with:
          go-version: '1.21'
      - name: Validate Beta Image Version
        run: make validate-image-version STAGE=beta VERSION=${{ needs.get-versions.outputs.new_version }}

  version-validation-prod:
    needs: [get-versions, build-public-ecr]
    if: ${{ needs.get-versions.result == 'success' && needs.build-public-ecr.result == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v4
        with:
          go-version: '1.21'
      - name: Validate Prod Image Version
        run: make validate-image-version STAGE=prod VERSION=${{ needs.get-versions.outputs.new_version }}

  run-for-arm-beta:
    needs: version-bump
    if: ${{ needs.version-bump.outputs.bump_type != 'none' }}
    runs-on: ubuntu-latest
    steps:
      - name: Run
        run: |
          echo "Done"
    # uses: './.github/workflows/on-safe-to-test-label.yml'
    # with:
    #   architecture: 'arm64'
    #   environment: 'beta'

  run-for-x86-beta:
    needs: version-bump
    if: ${{ needs.version-bump.outputs.bump_type != 'none' }}
    runs-on: ubuntu-latest
    steps:
      - name: Run
        run: |
          echo "Done"
    # uses: './.github/workflows/on-safe-to-test-label.yml'
    # with:
    #   architecture: 'x86_64'
    #   environment: 'beta'

  run-helm-tests-beta:
    needs: version-bump
    if: ${{ needs.version-bump.outputs.bump_type != 'none' }}
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'
    - name: Set up Helm
      uses: azure/setup-helm@v4
      with:
        version: '3.16.4'
    - name: Set up kubectl
      uses: azure/setup-kubectl@v4
      with:
        version: 'v1.28.0'
    - name: Set up Docker
      uses: docker/setup-buildx-action@v3
    - name: Install Development Tools
      run: sudo apt-get update && sudo apt-get install -y build-essential
    - name: Download and verify Go dependencies
      run: |
        go mod download
        go mod verify
        go mod tidy
    - name: Run test cases with Kind cluster
      run: |
        make helmE2ETestBeta
    - name: Terminate Kind cluster
      if: always()
      run: make kind-cluster-delete

  update-chart:
    needs: [run-for-arm-beta, run-for-x86-beta, run-helm-tests-beta, get-versions]
    if: ${{ needs.run-for-arm-beta.result == 'success' && needs.run-for-x86-beta.result == 'success' && needs.run-helm-tests-beta.result == 'success' && needs.get-versions.result == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ssh-key: ${{ secrets.DEPLOY_KEY }}
      - name: Modify chart
        run: |
          NEW_VERSION="${{ needs.get-versions.outputs.new_version }}"
          sed -i "s/^version: .*/version: ${NEW_VERSION}/" charts/aws-pca-issuer/Chart.yaml
          sed -i "s/^appVersion: .*/appVersion: ${NEW_VERSION}/" charts/aws-pca-issuer/Chart.yaml
      - name: Push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add .
          git commit -m "Update chart version to ${{ needs.get-versions.outputs.new_version }}" --signoff
          git push

  build-public-ecr:
    needs: [get-versions, update-chart]
    if: ${{ needs.update-chart.result == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Dockerx
        uses: docker/setup-buildx-action@v1
      - name: Setup AWS Credentials
        uses: aws-actions/configure-aws-credentials@master
        with:
          role-to-assume: arn:aws:iam::905418208571:role/GithubActionsPublishRole-wrichman-us-east-1
          aws-region: us-east-1
      - name: Login to Public ECR
        uses: docker/login-action@v1
        with:
          registry: public.ecr.aws
        env:
          AWS_REGION: us-east-1
      - name: Setup Push to Public ECR
        run: |
          export TAG_BASE=${{ env.PROD_ECR_REPO }}/$(echo ${GITHUB_REPOSITORY,,} | sed s#/#-#)
          echo TAG_BASE=$TAG_BASE >> $GITHUB_ENV
      - name: Build and push container images
        uses: docker/build-push-action@v6
        with:
          build-args: |
            pkg_version=${{ needs.get-versions.outputs.new_version }}
            user_agent=${{ env.ECR_USER_AGENT }}
          context: .
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ env.TAG_BASE }}:latest
            ${{ env.TAG_BASE }}:${{ needs.get-versions.outputs.new_version }}
          push: true

  publish-helm-chart:
    needs: [build-public-ecr, update-chart]
    if: ${{ needs.build-public-ecr.result == 'success' && needs.update-chart.result == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Publish Helm chart
        run: |
          echo "Done"

  run-for-arm-prod:
    needs: [publish-helm-chart]
    if: ${{ needs.publish-helm-chart.result == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Run
        run: |
          echo "Done"
    # uses: './.github/workflows/on-safe-to-test-label.yml'
    # with:
    #   architecture: 'arm64'
    #   environment: 'prod'

  run-for-x86-prod:
    needs: [publish-helm-chart]
    if: ${{ needs.publish-helm-chart.result == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Run
        run: |
          echo "Done"
    # uses: './.github/workflows/on-safe-to-test-label.yml'
    # with:
    #   architecture: 'x86_64'
    #   environment: 'prod'

  run-helm-tests-prod:
    needs: [publish-helm-chart]
    if: ${{ needs.publish-helm-chart.result == 'success' }}
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'
    - name: Set up Helm
      uses: azure/setup-helm@v4
      with:
        version: '3.16.4'
    - name: Set up kubectl
      uses: azure/setup-kubectl@v4
      with:
        version: 'v1.28.0'
    - name: Set up Docker
      uses: docker/setup-buildx-action@v3
    - name: Install Development Tools
      run: sudo apt-get update && sudo apt-get install -y build-essential
    - name: Download and verify Go dependencies
      run: |
        go mod download
        go mod verify
        go mod tidy
    - name: Run test cases with Kind cluster
      run: |
        make helmE2ETestProd
    - name: Terminate Kind cluster
      if: always()
      run: make kind-cluster-delete

  release:
    needs: [run-for-arm-prod, run-for-x86-prod, run-helm-tests-prod, get-versions]
    if: ${{ needs.run-for-arm-prod.result == 'success' && needs.run-for-x86-prod.result == 'success' && needs.run-helm-tests-prod.result == 'success'}}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.get-versions.outputs.new_version }}
          name: Release ${{ needs.get-versions.outputs.new_version }}
          generate_release_notes: true
